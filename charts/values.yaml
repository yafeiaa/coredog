# ============================================================================
# CoreDog é…ç½®æ–‡ä»¶
# ============================================================================

# ----------------------------------------------------------------------------
# é•œåƒé…ç½® (æ— éœ€ä¿®æ”¹ï¼Œé™¤éä½¿ç”¨è‡ªå®šä¹‰é•œåƒ)
# ----------------------------------------------------------------------------
image:
  repository: coderflyfyf/coredog
  tag: v1.0.7
  pullPolicy: IfNotPresent

# ----------------------------------------------------------------------------
# CoreDog æ ¸å¿ƒé…ç½® (éœ€è¦ç”¨æˆ·é…ç½®)
# ----------------------------------------------------------------------------
config:
  coredog: |-
    # å­˜å‚¨é…ç½® - ç”¨äºä¸Šä¼  core dump æ–‡ä»¶
    StorageConfig:
      enabled: true                          # æ˜¯å¦å¯ç”¨äº‘å­˜å‚¨ä¸Šä¼ 
      protocol: s3                           # å­˜å‚¨åè®®: s3, cos, cfs
                                             #   - s3: Amazon S3 å¯¹è±¡å­˜å‚¨
                                             #   - cos: è…¾è®¯äº‘ COS å¯¹è±¡å­˜å‚¨ï¼ˆå…¼å®¹ S3 APIï¼‰
                                             #   - cfs: è…¾è®¯äº‘ CFS æ–‡ä»¶å­˜å‚¨
      
      # ===== S3/COS é…ç½®ï¼ˆå½“ protocol=s3 æˆ– protocol=cos æ—¶ä½¿ç”¨ï¼‰=====
      # âš ï¸ å¿…å¡«é¡¹ï¼šS3 è®¿é—®å‡­è¯
      s3AccesskeyID: ""                      # å¡«å†™æ‚¨çš„ S3/COS Access Key ID
      s3SecretAccessKey: ""                  # å¡«å†™æ‚¨çš„ S3/COS Secret Access Key
      s3Region: ""                           # å¡«å†™ S3/COS åŒºåŸŸï¼Œå¦‚: us-east-1, ap-nanjing
      S3Bucket: ""                           # å¡«å†™ S3/COS bucket åç§°
      S3Endpoint: ""                         # å¡«å†™ S3/COS endpointï¼Œå¦‚: s3.amazonaws.com, cos.ap-nanjing.myqcloud.com
      
      # ===== CFS é…ç½®ï¼ˆå½“ protocol=cfs æ—¶ä½¿ç”¨ï¼‰=====
      CFSMountPath: ""                       # CFS æŒ‚è½½è·¯å¾„ï¼Œå¦‚: /mnt/cfs
      
      # é€šç”¨é…ç½®
      StoreDir: corefiles                    # å­˜å‚¨ç›®å½•å‰ç¼€
      PresignedURLExpireSeconds: 3600        # é¢„ç­¾å URL æœ‰æ•ˆæœŸï¼ˆç§’ï¼Œä»… S3/COS ä½¿ç”¨ï¼‰
      
      # âš ï¸ é‡è¦ï¼šæœ¬åœ°æ–‡ä»¶æ¸…ç†é…ç½®
      DeleteLocalCorefile: true              # ä¸Šä¼ æˆåŠŸåæ˜¯å¦åˆ é™¤æœ¬åœ°æ–‡ä»¶ï¼ˆå¼ºçƒˆæ¨èè®¾ä¸º trueï¼Œé¿å…ç£ç›˜è¢«å æ»¡ï¼‰
    
    # é«˜çº§æ¸…ç†é…ç½®ï¼ˆå¯é€‰ï¼Œé€šå¸¸æ— éœ€ä¿®æ”¹ï¼‰
    gc: false                                # ä¿æŒ falseï¼Œç”± DeleteLocalCorefile æ§åˆ¶
    gc_type: rm                              # æ¸…ç†æ–¹å¼:
                                             #   rm - åˆ é™¤æ–‡ä»¶ï¼ˆæ¨èï¼Œå½»åº•æ¸…ç†ï¼‰
                                             #   truncate - æ¸…ç©ºæ–‡ä»¶å†…å®¹ä½†ä¿ç•™æ–‡ä»¶ï¼ˆç”¨äºç‰¹æ®Šå®¡è®¡éœ€æ±‚ï¼Œå¯ä»¥ä½œä¸ºå‘ç”Ÿè¿‡core dumpçš„è¯æ®ï¼‰
    
    # Core dump æ–‡ä»¶ç›®å½•ï¼ˆå®¹å™¨å†…è·¯å¾„ï¼Œæ— éœ€ä¿®æ”¹ï¼‰
    CorefileDir: /corefile
    
    # âš ï¸ é€šçŸ¥é…ç½®ï¼šCore dump å‘ç”Ÿæ—¶çš„æ¶ˆæ¯æ¨¡æ¿ï¼ˆæ”¯æŒ Markdown æ ¼å¼ï¼‰
    messageTemplate: |
      ğŸš¨ **åº”ç”¨å´©æºƒå‘Šè­¦**
      
      ğŸ“¦ Namespace: `{pod.namespace}`
      ğŸ·ï¸  Pod: `{pod.name}`
      ğŸ–¥ï¸  Node: `{pod.node}`
      ğŸ“¥ ä¸‹è½½: {corefile.url}
    
    # å¯é€‰ï¼šè‡ªå®šä¹‰æ¶ˆæ¯æ ‡ç­¾
    messageLabels: {}
    
    # âš ï¸ é€šçŸ¥æ¸ é“é…ç½®ï¼ˆè‡³å°‘é…ç½®ä¸€ä¸ªä»¥æ¥æ”¶å‘Šè­¦ï¼‰
    NoticeChannel: []
    # ç¤ºä¾‹é…ç½®ï¼š
    # NoticeChannel:
    #   - chan: wechat                       # ä¼ä¸šå¾®ä¿¡
    #     webhookurl: "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx"
    #     keyword: ""                        # å¯é€‰ï¼šåªæœ‰è·¯å¾„åŒ…å«æ­¤å…³é”®è¯æ‰é€šçŸ¥
    #   - chan: slack                        # Slack
    #     webhookurl: "https://hooks.slack.com/services/xxx"
    #     keyword: "production"

# ----------------------------------------------------------------------------
# Watcher é…ç½® (æ— éœ€ä¿®æ”¹)
# ----------------------------------------------------------------------------
watcher:
  kubeLookup: true                           # æ˜¯å¦é€šè¿‡ K8s API æŸ¥è¯¢ Pod UID

# ----------------------------------------------------------------------------
# Core dump Volume é…ç½® (æ— éœ€ä¿®æ”¹ï¼Œé™¤éè¦æ›´æ”¹å­˜å‚¨è·¯å¾„)
# ----------------------------------------------------------------------------
corefileVolume:
  type: hostPath
  name: corefile
  hostPath:
    path: /data/coredog-system/dumps                         # å®¿ä¸»æœºå­˜å‚¨è·¯å¾„
    type: DirectoryOrCreate                  # è‡ªåŠ¨åˆ›å»ºç›®å½•

# ----------------------------------------------------------------------------
# Webhook é…ç½®
# ----------------------------------------------------------------------------
webhook:
  enabled: true                              # æ˜¯å¦å¯ç”¨ webhook è‡ªåŠ¨æ³¨å…¥
  replicas: 2                                # Webhook å‰¯æœ¬æ•°ï¼ˆå»ºè®® >= 2 ä¿è¯é«˜å¯ç”¨ï¼‰
  failurePolicy: Ignore                      # Webhook å¤±è´¥ç­–ç•¥: Ignore (ä¸é˜»å¡) æˆ– Fail (é˜»å¡ Pod åˆ›å»º)
  
  # Namespace é€‰æ‹©å™¨ï¼šæ§åˆ¶å“ªäº› namespace ä¼šè¢« webhook å¤„ç†ï¼ˆå¯é€‰ï¼‰
  # å¦‚æœä¸é…ç½®ï¼Œåˆ™æ‰€æœ‰ namespace éƒ½ä¼šè¢«å¤„ç†ï¼ˆä½†ä»éœ€ Pod æœ‰ coredog.io/inject=true æ³¨è§£ï¼‰
  namespaceSelector: {}
  # ç¤ºä¾‹ï¼šåªå¤„ç†å¸¦æœ‰ç‰¹å®šæ ‡ç­¾çš„ namespace
  # namespaceSelector:
  #   matchExpressions:
  #   - key: coredog.io/enabled
  #     operator: In
  #     values: ["true"]
  
  # Webhook èµ„æºé…ç½®ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi
  
  # æ³¨æ„ï¼šWebhook å¤±è´¥å‘Šè­¦ä¼šè‡ªåŠ¨å¤ç”¨ NoticeChannel é…ç½®å‘é€

# ============================================================================
# é…ç½®è¯´æ˜
# ============================================================================
# 
# å¿…å¡«é…ç½®é¡¹ï¼ˆæ ‡è®°ä¸º âš ï¸ï¼‰ï¼š
#   1. StorageConfig.s3AccesskeyID - S3 è®¿é—®å¯†é’¥
#   2. StorageConfig.s3SecretAccessKey - S3 ç§é’¥
#   3. StorageConfig.s3Region - S3 åŒºåŸŸ
#   4. StorageConfig.S3Bucket - S3 bucket åç§°
#   5. StorageConfig.S3Endpoint - S3 endpoint
#   6. NoticeChannel - è‡³å°‘é…ç½®ä¸€ä¸ªé€šçŸ¥æ¸ é“
#
# å¯é€‰é…ç½®é¡¹ï¼š
#   - webhook.alert - Webhook å¤±è´¥å‘Šè­¦ï¼ˆæ¨èå¯ç”¨ï¼‰
#   - messageLabels - è‡ªå®šä¹‰æ¶ˆæ¯æ ‡ç­¾
#   - keyword - é€šçŸ¥è¿‡æ»¤å…³é”®è¯ï¼Œä¸é…ç½®åˆ™ä¸è¿‡æ»¤
#
# æ— éœ€ä¿®æ”¹çš„é…ç½®ï¼š
#   - image.* - é•œåƒé…ç½®
#   - watcher.* - Watcher é…ç½®
#   - corefileVolume.* - Volume é…ç½®ï¼ˆé™¤éè¦æ›´æ”¹è·¯å¾„ï¼‰
#   - webhook.resources - Webhook èµ„æºé…ç½®
#
# ============================================================================
